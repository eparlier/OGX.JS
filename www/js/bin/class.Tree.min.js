OGX.Tree=function(e){"use strict";var _,c,d,m,t,r,a,i,n=this,f=e,o={show_root:!0,root_label:"root",editable:!1,sort:{enabled:!0,property:"label",way:1},toggle:!0,drag_after:1e3,icon_path:"img/",icon_size:30,scope:["public"],chromeos:!1,types:{root:{mode:"folder",icons:{open:"folder_open.svg",close:"folder_close.svg",empty:null}},file:{mode:"file",icon:"file.svg"},folder:{mode:"folder",icons:{open:"folder_open.svg",close:"folder_close.svg",empty:null}}},tree:{id:0,type:"root",label:f.root_label,state:"closed",items:[]},template:'<div class="ogx_tree_item" data-id="{{$_id_}}"><span class="ogx_tree_item_arrow {{$arrow_style}} {{$arrow_display}}"><span style="width:{{$arrow_size}}; height:{{$arrow_size}}"></span></span><img src="{{$icon}}" width="{{$size}}" alt=""><div class="ogx_tree_item_label">{{$label}}</div><div class="ogx_tree_item_container {{$container_display}}"></div></div>'},s="mousedown",l="mouseup",p="mousemove";function u(){var e={icon:E(f.tree),size:f.icon_size,_id_:f.tree._id_,label:f.root_label,container_display:"",arrow_display:"",arrow_style:"ogx_tree_item_arrow_open",arrow_size:Math.round(f.icon_size/2)+"px"};_.html(OGX.Templater.templatize(e,f.template)),f.tree.element=_.children(".ogx_tree_item:first")}function g(){u(),h(f.tree,f.tree.element)}function h(e,t){if(e.hasOwnProperty("items")){var r,i;f.sort.enabled?(o=e.items,s=f.sort.property,a=f.sort.way,o.sort((l=s,_=a,function(e,t){return e[l]<t[l]?-1*_:e[l]>t[l]?_:0})),r=o):r=e.items;for(var n=0;n<r.length;n++)i={icon:null,size:f.icon_size,_id_:e.items[n]._id_,label:e.items[n].label,container_display:"",arrow_display:"",arrow_style:"",arrow_size:Math.round(f.icon_size/2)+"px"},e.items[n].hasOwnProperty("state")||(e.items[n].state="close"),"folder"===P(e.items[n])?(e.items[n].items.length||(e.items[n].state="close",i.arrow_style="ogx_tree_item_arrow_disabled"),"open"===e.items[n].state?i.arrow_style="ogx_tree_item_arrow_open":(i.arrow_style+=" ogx_tree_item_arrow_close",i.container_display="ogx_tree_item_container_hidden")):i.arrow_display="ogx_tree_item_arrow_hidden",i.icon=E(e.items[n]),t.children(".ogx_tree_item_container:last").append(OGX.Templater.templatize(i,f.template)),e.items[n].element=t.children(".ogx_tree_item_container:last").children(".ogx_tree_item:last"),h(e.items[n],e.items[n].element)}var o,s,a,l,_}function y(e){var t=JSON.parse(JSON.stringify(e));return delete t._id_,delete t.element,t}function w(e){"folder"===P(e)&&(e.items.length||(e.state="close",e.element.children(".ogx_tree_item_arrow:first").addClass("ogx_tree_item_arrow_disabled")),"open"===e.state?(e.element.children(".ogx_tree_item_arrow:first").removeClass("ogx_tree_item_arrow_close").removeClass("ogx_tree_item_arrow_disabled").addClass("ogx_tree_item_arrow_open"),e.element.children(".ogx_tree_item_container:first").css("display","block")):(e.element.children(".ogx_tree_item_arrow:first").removeClass("ogx_tree_item_arrow_open").addClass("ogx_tree_item_arrow_close"),e.element.children(".ogx_tree_item_container:first").css("display","none")),e.element.children("img:first").attr("src",E(e)))}function v(){if(a){var e=b(a);e&&(e.children("img:first").removeClass("ogx_tree_selected_item"),a=null)}}function x(n){return G(function(e,t,r,i){return e._id_===n&&(r.items.splice(i,1),r.items.length||(r.state="close"),w(r),!0)})}function O(t,r){return G(function(e){return e._id_===r&&(e.items.push(t),e.state="open",w(e),!0)})}function T(r){return G(function(e,t){return e._id_===r&&e})}function b(e){var t=T(e);return!!t&&t.element}function C(e){var r,t=(r=e,G(function(e,t){return r===t+"/"+e.label&&e}));return!!t&&t.element}function G(s,e){var a;if(void 0===e&&(e=f.tree),a=function e(t,r,i,n){if(a=s(t,r,i,n))return a;if(t.hasOwnProperty("items")&&t.items.length)for(var o=0;o<t.items.length;o++)if(a=e(t.items[o],r+"/"+t.label,t,o))return a;return!1}(e,""))return a}function E(e){return!!f.types.hasOwnProperty(e.type)&&(f.types[e.type].hasOwnProperty("icons")?"close"===e.state&&!e.items.length&&f.types[e.type].icons.hasOwnProperty("empty")?f.icon_path+f.types[e.type].icons.empty:f.icon_path+f.types[e.type].icons[e.state]:f.icon_path+f.types[e.type].icon)}function P(e){return!!f.types.hasOwnProperty(e.type)&&f.types[e.type].mode}function X(e){var t,r;r=y(T(t=e.data("id"))),f.toggle?e.children("img:first").hasClass("ogx_tree_selected_item")?(v(),_.trigger(OGX.Tree.UNSELECT,r)):(v(),e.children("img:first").addClass("ogx_tree_selected_item"),a=t,_.trigger(OGX.Tree.SELECT,r)):(v(),e.children("img:first").addClass("ogx_tree_selected_item"),_.trigger(OGX.Tree.SELECT,r))}function z(e){e?(f.editable?(_.on(s,".ogx_tree_item img",function(e){e.preventDefault(),X($(this).parent(0)),1!==$(this).parent(0).data("id")&&function(){t&&clearInterval(t);r=(new Date).getTime(),t=setInterval(S,50)}()}),$(document).on(l,function(){var e,t,r,i,n,o,s,a,l;D(),d&&(I(!1),e=d.offset().left,t=d.offset().top,i=e,n=t,!(r=G(function(e,t){return o=e.element.offset(),s=e.element.children("img:first"),i>=o.left&&i<=o.left+s.width()&&n>=o.top&&n<=o.top+s.height()&&e}))||r&&(r._id_===c._id_||"folder"!==P(r))?(m.css("opacity",1),d.remove(),c=d=null):(l=r,x((a=c)._id_),O(a,l._id_),l.element.children(".ogx_tree_item_container:first").empty(),l.state="open",h(l,l.element),w(l),m.remove(),d.remove(),d=null,_.trigger(OGX.Tree.DROP,c),c=null))})):_.on("click",".ogx_tree_item img",function(e){e.preventDefault(),X($(this).parent(0))}),_.on(s,".ogx_tree_item_arrow",function(e){if(e.preventDefault(),D(),0<$(this).parent(0).children(".ogx_tree_item_container:first").children().length){var t=T($(this).parent(0).data("id"));"open"===t.state?(t.state="close",_.trigger(OGX.Tree.CLOSE,t)):(t.state="open",_.trigger(OGX.Tree.OPEN,t)),w(t)}})):(f.editable?_.off(s,".ogx_tree_item img"):_.off("click",".ogx_tree_item img"),_.off(s,".ogx_tree_item_arrow"))}function S(){var e;(new Date).getTime()-r>=f.drag_after&&(a&&(c=T(a))&&(e=c.element,(d=(m=e).clone()).children(".ogx_tree_item_arrow:first").css("display","none"),e.css("opacity",.3),d.addClass("ogx_tree_item_drag"),d.css({top:e.offset().top,left:e.offset().left}),_.prepend(d),I(!0),_.trigger(OGX.Tree.DRAG,c)),D())}function I(e){e?$(document).on(p,function(e){e=function(e){if(e.hasOwnProperty("originalEvent")&&void 0!==e.originalEvent.changedTouches)return e.originalEvent.changedTouches[0];return e}(e),d.css({top:e.pageY+"px",left:e.pageX+"px"})}):$(document).off(p)}function D(){t&&(clearInterval(t),t=null)}this._NAME_=OGX.Tree.NAME,this.el=null,this.setIconSize=function(r){f.icon_size=r,_.find("img").each(function(e,t){$(t).attr("width",r)}),$(".ogx_tree_item_arrow span").css("width",Math.round(f.icon_size/2)+"px"),$(" .ogx_tree_item_arrow span").css("height",Math.round(f.icon_size/2)+"px")},this.addItem=function(e){if(a){var t=T(a);return"folder"===P(t)&&(e._id_=++i,O(e,a),t.element.children(".ogx_tree_item_container:first").empty(),t.state="open",h(t,t.element),t.element.children(".ogx_tree_item_container:first").css("display","block")),!0}return!1},this.selectItemByPropVal=function(e,t){var r,i,n,o,s=(r=e,i=t,G(function(e,t){return!(!e.data.hasOwnProperty(r)||e.data[r]!==i)&&t+"/"+e.label}));return!!s&&(v(),n=s._id_,(o=b(n))&&(a=n,o.children("img:first").addClass("ogx_tree_selected_item")),!0)},this.selectItemByPath=function(e){var t=C(e);return!!t&&(v(),t.addClass("ogx_tree_selected_item"),a=t.data("id"),!0)},this.updateSelectedItemDataProperty=function(e,t){return!!a&&(T(a).data[e]=t,!0)},this.updateSelectedItemData=function(e){return!!a&&(T(a).data=e,!0)},this.updateSelectedItemLabel=function(e){if(a){var t=T(a);return t.label=e,b(t._id_).children(".ogx_tree_item_label:first").html(e),!0}return!1},this.deleteItemByPath=function(e){var t=C(e);return!!t&&x(t.data("id"))},this.deleteSelectedItem=function(){return function(){if(a)return G(function(e,t,r,i){if(e._id_===a)return e.element.remove(),r.items.splice(i,1),w(r),!0});return!1}()},this.getSelectedItem=function(){return function(){if(a)return T(a);return!1}()},this.getTree=function(){var e=G(y,JSON.parse(JSON.stringify(f.tree)));if(e)return e},this.setData=function(e){e.hasOwnProperty("types")&&this.setTypes(e.types),e.hasOwnProperty("tree")&&this.setTree(e.tree)},this.setTypes=function(e){f.types=e},this.setTree=function(e){f.tree=e,f.tree.hasOwnProperty("state")||(f.tree.state="open"),i=1,G(function(e){return e._id_=i++,!1}),g()},this.newTree=function(){i=1,f.tree={_id_:i,type:"root",state:"open",label:f.root_label,element:null,items:[]},u()},this.destroy=function(){z(!1)},void 0!==OGX.Templater?(function(){for(var e in o)f.hasOwnProperty(e)||(f[e]=o[e]);void 0===window.ontouchstart||f.chromeos||(s="touchstart",p="touchmove",l="touchend"),n.el=_=$(f.container)}(),z(!0),f.tree&&g()):console.log("%c CRITICAL ERROR - OGX.Templater not found! ","background:#222; color: #FF0000")},OGX.Tree.NAME="OgxTree",OGX.Tree.SELECT="TreeSelect",OGX.Tree.UNSELECT="TreeUnselect",OGX.Tree.OPEN="TreeOpen",OGX.Tree.CLOSE="TreeClose",OGX.Tree.DRAG="TreeDrag",OGX.Tree.DROP="TreeDrop";