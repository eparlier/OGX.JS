OGX.Tree=function(e){"use strict";var _,d,c,m,t,r,s,n,o=this,p=e,i={show_root:!0,root_label:"root",editable:!1,reorder:!1,toggle:!0,drag_after:1e3,icon_path:"img/",scope:["public"],types:[{type:"root",mode:"folder",icons:{open:"folder_open.png",close:"folder_open.png"}},{type:"file",mode:"file",icon:"file.png"},{type:"folder",mode:"folder",icons:{open:"folder_open.png",close:"folder_open.png"}}],tree:{id:0,type:"root",label:p.root_label,state:"closed",items:[]},template:'<div class="ogx_tree_{{$type}} ogx_tree_item" data-type="{{$type}}" data-mode="{{$mode}}" data-id="{{$id}}" data-state="{{$state}}"><span class="ogx_tree_item_arrow {{$arrow_style}} {{$arrow_display}}"><span></span></span><img src="{{$icon}}" {{$css}} alt=""><div class="ogx_tree_item_label">{{$label}}</div><div class="ogx_tree_container {{$container_display}}"></div></div>'};function a(){var e={icon:T("root","open"),mode:"folder",type:"root",_id_:p.tree._id_,label:p.root_label,state:"open",container_display:"",arrow_display:"",arrow_style:"ogx_tree_item_arrow_open"};_.html(OGX.Templater.templatize(e,p.template)),p.tree.element=_.children(".ogx_tree_root:first"),p.tree.label=p.root_label,f(p.tree,p.tree.element)}function f(e,t){if(e.hasOwnProperty("items")){var r,n;p.reorder?(i=e.items,a="type",s=1,i.sort((l=a,_=s,function(e,t){return e[l]<t[l]?-1*_:e[l]>t[l]?_:0})),r=i):r=e.items;for(var o=0;o<r.length;o++)n={icon:null,mode:b(e.items[o].type),type:e.items[o].type,_id_:e.items[o]._id_,label:e.items[o].label,state:0,container_display:"",arrow_display:"",arrow_style:""},e.items[o].hasOwnProperty("state")&&(n.state=e.items[o].state),"folder"!==n.mode?n.arrow_display="ogx_tree_item_arrow_hidden":(n.state||(n.state="open"),e.items[o].items.length||(n.arrow_style+=" ogx_tree_item_arrow_alpha")),"close"===n.state?n.container_display="ogx_tree_item_container_hidden":n.arrow_style+=" ogx_tree_item_arrow_open",n.icon=T(e.items[o].type,n.state),t.children(".ogx_tree_container:last").append(OGX.Templater.templatize(n,p.template)),e.items[o].element=t.children(".ogx_tree_container:last").children(".ogx_tree_item:last"),f(e.items[o],e.items[o].element)}var i,a,s,l,_}function l(e){var t=JSON.parse(JSON.stringify(e));return delete t._id_,delete t.element,t}function u(){if(s){var e=v(s);e&&(e.children("img:first").removeClass("ogx_tree_selected"),s=null)}}function g(o){return w(function(e,t,r,n){return e._id_===o&&(r.items.splice(n,1),!0)})}function h(t,r){return w(function(e){return e._id_===r&&(e.items.push(t),!0)})}function y(r){return w(function(e,t){return e._id_===r&&e})}function v(e){var t=y(e);return!!t&&t.element}function x(e){var r,t=(r=e,w(function(e,t){return r===t+"/"+e.label&&e}));return!!t&&t.element}function w(a,e){var s;if(void 0===e&&(e=p.tree),s=function e(t,r,n,o){if(s=a(t,r,n,o))return s;if(t.hasOwnProperty("items")&&t.items.length)for(var i=0;i<t.items.length;i++)if(s=e(t.items[i],r+"/"+t.label,t,i))return s;return!1}(e,""))return s}function O(e){for(var t=0;t<p.types.length;t++)if(p.types[t].type===e)return p.types[t];return!1}function T(e,t){void 0!==t&&t||(t="close");var r=O(e);return!!r&&(r.hasOwnProperty("icons")?p.icon_path+r.icons[t]:p.icon_path+r.icon)}function b(e){var t=O(e);return!!t&&t.mode}function C(e,t){var r=e.data("type");t?e.children("img").attr("src",T(r,"open")):e.children("img").attr("src",T(r,"close"))}function G(e){var t,r;r=l(y(t=e.data("id"))),p.toggle?e.children("img:first").hasClass("ogx_tree_selected")?(u(),_.trigger(OGX.Tree.UNSELECT,r)):(u(),e.children("img:first").addClass("ogx_tree_selected"),s=t,_.trigger(OGX.Tree.SELECT,r)):(u(),e.children("img:first").addClass("ogx_tree_selected"),_.trigger(OGX.Tree.SELECT,r))}function X(e){e?(p.editable?(_.on("mousedown",".ogx_tree_item img",function(e){e.preventDefault(),G($(this).parent(0)),function(){t&&clearInterval(t);r=(new Date).getTime(),t=setInterval(E,50)}()}),$(document).on("mouseup",function(){var e,t,r,n,o,i,a,s,l;S(),c&&(P(!1),r=c.offset().left,n=c.offset().top,i=r,a=n,!(o=w(function(e,t){return s=e.element.offset(),l=e.element.children("img:first"),i>=s.left&&i<=s.left+l.width()&&a>=s.top&&a<=s.top+l.height()&&e}))||o&&(o.id===d.id||"folder"!==b(o.type))?(m.css("opacity",1),c.remove(),d=c=null):(t=o,g((e=d)._id_),h(e,t._id_),t.element.children(".ogx_tree_item_arrow:first").removeClass("ogx_tree_item_arrow_alpha").removeClass("ogx_tree_item_arrow_close").addClass("ogx_tree_item_arrow_open"),1===e.element.parent(0).children().length&&e.element.parent(0).parent(0).children(".ogx_tree_item_arrow:first").addClass("ogx_tree_item_arrow_alpha").removeClass("ogx_tree_item_arrow_open").addClass("ogx_tree_item_arrow_close"),t.element.children(".ogx_tree_container:first").empty(),f(t,t.element),m.remove(),c.remove(),c=null,_.trigger(OGX.Tree.DROP,d),d=null))})):_.on("click",".ogx_tree_item img",function(e){e.preventDefault(),G($(this).parent(0))}),_.on("mousedown",".ogx_tree_item_arrow",function(e){e.preventDefault(),S(),0<$(this).parent(0).children(".ogx_tree_container:first").children().length&&($(this).parent(0).children(".ogx_tree_container:first").toggle(),"none"===$(this).parent(0).children(".ogx_tree_container:first").css("display")?$(this).css("transform","rotate(0deg)"):$(this).css("transform","rotate(90deg)"),"folder"===$(this).parent(0).data("mode")&&("open"===$(this).parent(0).data("state")?(C($(this).parent(0),!1),$(this).parent(0).data("state","close"),$(p.container).trigger(OGX.Tree.CLOSE,y($(this).parent(0).data("data",n)))):(C($(this).parent(0),!0),$(this).parent(0).data("state","open"),$(p.container).trigger(OGX.Tree.OPEN,y($(this).parent(0).data("data",n))))))})):(p.editable?_.off("mousedown",".ogx_tree_item img"):_.off("click",".ogx_tree_item img"),_.off("mousedown",".ogx_tree_item_arrow"))}function E(){var e;(new Date).getTime()-r>=p.drag_after&&(s&&(d=y(s))&&(e=d.element,(c=(m=e).clone()).children(".ogx_tree_item_arrow:first").css("display","none"),e.css("opacity",.3),c.addClass("ogx_tree_item_drag"),c.css({top:e.offset().top,left:e.offset().left}),_.prepend(c),P(!0),_.trigger(OGX.Tree.DRAG,d)),S())}function P(e){e?$(document).on("mousemove",function(e){e.preventDefault(),c.css({top:e.pageY+"px",left:e.pageX+"px"})}):$(document).off("mousemove")}function S(){t&&(clearInterval(t),t=null)}this._NAME_=OGX.Tree.NAME,this.el=null,this.addItem=function(e){if(s){var t=y(s);return"folder"===b(t.type)&&(h(e,s),t.element.children(".ogx_tree_container:first").empty(),f(t,t.element)),!0}return!1},this.selectItemByPropVal=function(e,t){var r,n,o,i,a=(r=e,n=t,w(function(e,t){return!(!e.data.hasOwnProperty(r)||e.data[r]!==n)&&t+"/"+e.label}));return!!a&&(u(),o=a._id_,(i=v(o))&&(s=o,i.children("img:first").addClass("ogx_tree_selected")),!0)},this.selectItemByPath=function(e){var t=x(e);return!!t&&(u(),t.addClass("ogx_tree_selected"),s=t.data("id"),!0)},this.updateSelectedItemDataProperty=function(e,t){return!!s&&(y(s).data[e]=t,!0)},this.updateSelectedItemData=function(e){return!!s&&(y(s).data=e,!0)},this.updateSelectedItemLabel=function(e){if(s){var t=y(s);return t.label=e,v(t._id_).children(".ogx_tree_item_label:first").html(e),!0}return!1},this.deleteItemByPath=function(e){var t=x(e);return!!t&&g(t.data("id"))},this.deleteSelectedItem=function(){return function(){if(s)return w(function(e,t,r,n){if(e._id_===s)return e.element.remove(),r.splice(n,1),!0});return!1}()},this.getTree=function(){var e=w(l,JSON.parse(JSON.stringify(p.tree)));if(e)return e},this.setData=function(e){e.hasOwnProperty("types")&&this.setTypes(e.types),e.hasOwnProperty("tree")&&this.setTree(e.tree)},this.setTypes=function(e){p.types=e},this.setTree=function(e){p.tree=e,n=1,w(function(e){return e._id_=n++,!1}),a()},this.newTree=function(){!function(){n=1,p.tree={_id_:n,type:"root",mode:"folder",label:p.root_label,element:null,scopes:[],items:[]};var e={icon:T("root"),mode:"folder",type:"root",_id_:p.tree._id_,label:p.root_label,css:""};_.html(OGX.Templater.templatize(e,p.template)),p.tree.element=_.children(".ogx_tree_root:first")}()},this.destroy=function(){X(!1)},void 0!==OGX.Templater?(function(){for(var e in i)p.hasOwnProperty(e)||(p[e]=i[e]);o.el=_=$(p.container)}(),X(!0),p.tree&&a()):console.log("%c CRITICAL ERROR - OGX.Templater not found! ","background:#222; color: #FF0000")},OGX.Tree.NAME="OgxTree",OGX.Tree.SELECT="TreeSelect",OGX.Tree.UNSELECT="TreeUnselect",OGX.Tree.OPEN="TreeOpen",OGX.Tree.CLOSE="TreeClose",OGX.Tree.DRAG="TreeDrag",OGX.Tree.DROP="TreeDrop";