OGX.Tree=function(e){"use strict";var _,c,d,m,t,r,a,i,n=this,f=e,o={show_root:!0,root_label:"root",editable:!1,sort:{enabled:!0,property:"label",way:1},toggle:!0,drag_after:1e3,icon_path:"img/",icon_size:30,scope:["public"],chromeos:!1,types:{root:{mode:"folder",icons:{open:"folder_open.svg",close:"folder_close.svg",empty:null}},file:{mode:"file",icon:"file.svg"},folder:{mode:"folder",icons:{open:"folder_open.svg",close:"folder_close.svg",empty:null}}},tree:{id:0,type:"root",label:f.root_label,state:"closed",items:[]},template:'<div class="ogx_tree_item" data-id="{{$_id_}}"><span class="ogx_tree_item_arrow {{$arrow_style}} {{$arrow_display}}"><span style="width:{{$arrow_size}}; height:{{$arrow_size}}"></span></span><img src="{{$icon}}" width="{{$size}}" alt=""><div class="ogx_tree_item_label">{{$label}}</div><div class="ogx_tree_item_container {{$container_display}}"></div></div>'},s=(new Date).getTime()+""+Math.round(1e3*Math.random()),l="mousedown",p="mouseup",u="mousemove";function g(){var e={icon:X(f.tree),size:f.icon_size,_id_:f.tree._id_,label:f.root_label,container_display:"",arrow_display:"",arrow_style:"ogx_tree_item_arrow_open",arrow_size:Math.round(f.icon_size/2)+"px"};_.html(OGX.Templater.templatize(e,f.template)),f.tree.element=_.children(".ogx_tree_item:first")}function h(){g(),y(f.tree,f.tree.element)}function y(e,t){if(e.hasOwnProperty("items")){var r,i;f.sort.enabled?(o=e.items,s=f.sort.property,a=f.sort.way,o.sort((l=s,_=a,function(e,t){return e[l]<t[l]?-1*_:e[l]>t[l]?_:0})),r=o):r=e.items;for(var n=0;n<r.length;n++)i={icon:null,size:f.icon_size,_id_:e.items[n]._id_,label:e.items[n].label,container_display:"",arrow_display:"",arrow_style:"",arrow_size:Math.round(f.icon_size/2)+"px"},e.items[n].hasOwnProperty("state")||(e.items[n].state="close"),"folder"===z(e.items[n])?(e.items[n].items.length||(e.items[n].state="close",i.arrow_style="ogx_tree_item_arrow_disabled"),"open"===e.items[n].state?i.arrow_style="ogx_tree_item_arrow_open":(i.arrow_style+=" ogx_tree_item_arrow_close",i.container_display="ogx_tree_item_container_hidden")):i.arrow_display="ogx_tree_item_arrow_hidden",i.icon=X(e.items[n]),t.children(".ogx_tree_item_container:last").append(OGX.Templater.templatize(i,f.template)),e.items[n].element=t.children(".ogx_tree_item_container:last").children(".ogx_tree_item:last"),y(e.items[n],e.items[n].element)}var o,s,a,l,_}function w(e){var t=JSON.parse(JSON.stringify(e));return delete t._id_,delete t.element,t}function v(e){"folder"===z(e)&&(e.items.length||(e.state="close",e.element.children(".ogx_tree_item_arrow:first").addClass("ogx_tree_item_arrow_disabled")),"open"===e.state?(e.element.children(".ogx_tree_item_arrow:first").removeClass("ogx_tree_item_arrow_close").removeClass("ogx_tree_item_arrow_disabled").addClass("ogx_tree_item_arrow_open"),e.element.children(".ogx_tree_item_container:first").css("display","block")):(e.element.children(".ogx_tree_item_arrow:first").removeClass("ogx_tree_item_arrow_open").addClass("ogx_tree_item_arrow_close"),e.element.children(".ogx_tree_item_container:first").css("display","none")),e.element.children("img:first").attr("src",X(e)))}function x(){if(a){var e=C(a);e&&(e.children("img:first").removeClass("ogx_tree_selected_item"),a=null)}}function O(n){return E(function(e,t,r,i){return e._id_===n&&(r.items.splice(i,1),r.items.length||(r.state="close"),v(r),!0)})}function T(t,r){return E(function(e){return e._id_===r&&(e.items.push(t),e.state="open",v(e),!0)})}function b(r){return E(function(e,t){return e._id_===r&&e})}function C(e){var t=b(e);return!!t&&t.element}function G(e){var r,t=(r=e,E(function(e,t){return r===t+"/"+e.label&&e}));return!!t&&t.element}function P(){i=1,E(function(e){return e._id_=i++,!1})}function E(s,e){var a;if(void 0===e&&(e=f.tree),a=function e(t,r,i,n){if(a=s(t,r,i,n))return a;if(t.hasOwnProperty("items")&&t.items.length)for(var o=0;o<t.items.length;o++)if(a=e(t.items[o],r+"/"+t.label,t,o))return a;return!1}(e,""))return a}function X(e){return!!f.types.hasOwnProperty(e.type)&&(f.types[e.type].hasOwnProperty("icons")?"close"===e.state&&!e.items.length&&f.types[e.type].icons.hasOwnProperty("empty")?f.icon_path+f.types[e.type].icons.empty:f.icon_path+f.types[e.type].icons[e.state]:f.icon_path+f.types[e.type].icon)}function z(e){return!!f.types.hasOwnProperty(e.type)&&f.types[e.type].mode}function S(e){var t,r;r=w(b(t=e.data("id"))),f.toggle?e.children("img:first").hasClass("ogx_tree_selected_item")?(x(),_.trigger(OGX.Tree.UNSELECT,r)):(x(),e.children("img:first").addClass("ogx_tree_selected_item"),a=t,_.trigger(OGX.Tree.SELECT,r)):(x(),e.children("img:first").addClass("ogx_tree_selected_item"),_.trigger(OGX.Tree.SELECT,r))}function D(e){e?(f.editable?(_.on(l,".ogx_tree_item img",function(e){e.preventDefault(),S($(this).parent(0)),1!==$(this).parent(0).data("id")&&function(){t&&clearInterval(t);r=(new Date).getTime(),t=setInterval(I,50)}()}),$(document).on(p,function(){var e,t,r,i,n,o,s,a,l;L(),d&&(N(!1),e=d.offset().left,t=d.offset().top,i=e,n=t,!(r=E(function(e,t){return o=e.element.offset(),s=e.element.children("img:first"),i>=o.left&&i<=o.left+s.width()&&n>=o.top&&n<=o.top+s.height()&&e}))||r&&(r._id_===c._id_||"folder"!==z(r))?(m.css("opacity",1),d.remove(),c=d=null):(l=r,O((a=c)._id_),T(a,l._id_),l.element.children(".ogx_tree_item_container:first").empty(),l.state="open",y(l,l.element),v(l),m.remove(),d.remove(),d=null,_.trigger(OGX.Tree.DROP,c),c=null))})):_.on("click",".ogx_tree_item img",function(e){e.preventDefault(),S($(this).parent(0))}),_.on(l,".ogx_tree_item_arrow",function(e){if(e.preventDefault(),L(),0<$(this).parent(0).children(".ogx_tree_item_container:first").children().length){var t=b($(this).parent(0).data("id"));"open"===t.state?(t.state="close",_.trigger(OGX.Tree.CLOSE,t)):(t.state="open",_.trigger(OGX.Tree.OPEN,t)),v(t)}})):(f.editable?_.off(l,".ogx_tree_item img"):_.off("click",".ogx_tree_item img"),_.off(l,".ogx_tree_item_arrow"))}function I(){var e;(new Date).getTime()-r>=f.drag_after&&(a&&(c=b(a))&&(e=c.element,(d=(m=e).clone()).children(".ogx_tree_item_arrow:first").css("display","none"),e.css("opacity",.3),d.addClass("ogx_tree_item_drag"),d.css({top:e.offset().top,left:e.offset().left}),_.prepend(d),N(!0),_.trigger(OGX.Tree.DRAG,c)),L())}function N(e){e?$(document).on(u,function(e){e=function(e){if(e.hasOwnProperty("originalEvent")&&void 0!==e.originalEvent.changedTouches)return e.originalEvent.changedTouches[0];return e}(e),d.css({top:e.pageY+"px",left:e.pageX+"px"})}):$(document).off(u)}function L(){t&&(clearInterval(t),t=null)}this._NAME_=OGX.Tree.NAME,this.el=null,this.setIconSize=function(r){f.icon_size=r,_.find("img").each(function(e,t){$(t).attr("width",r)}),$(".ogx_tree_item_arrow span").css("width",Math.round(f.icon_size/2)+"px"),$(" .ogx_tree_item_arrow span").css("height",Math.round(f.icon_size/2)+"px")},this.addItem=function(e){if(a){var t=b(a);return"folder"===z(t)&&(e._id_=++i,T(e,a),t.element.children(".ogx_tree_item_container:first").empty(),t.state="open",y(t,t.element),t.element.children(".ogx_tree_item_container:first").css("display","block")),!0}return!1},this.selectItemByPropVal=function(e,t){var r,i,n,o,s=(r=e,i=t,E(function(e,t){return!(!e.data.hasOwnProperty(r)||e.data[r]!==i)&&t+"/"+e.label}));return!!s&&(x(),n=s._id_,(o=C(n))&&(a=n,o.children("img:first").addClass("ogx_tree_selected_item")),!0)},this.selectItemByPath=function(e){var t=G(e);return!!t&&(x(),t.addClass("ogx_tree_selected_item"),a=t.data("id"),!0)},this.updateSelectedItemDataProperty=function(e,t){return!!a&&(b(a).data[e]=t,!0)},this.updateSelectedItemData=function(e){return!!a&&(b(a).data=e,!0)},this.updateSelectedItemLabel=function(e){if(a){var t=b(a);return t.label=e,C(t._id_).children(".ogx_tree_item_label:first").html(e),!0}return!1},this.deleteItemByPath=function(e){var t=G(e);return!!t&&O(t.data("id"))},this.deleteSelectedItem=function(){return function(){if(a)return E(function(e,t,r,i){if(e._id_===a)return e.element.remove(),r.items.splice(i,1),v(r),!0});return!1}()},this.getSelectedItem=function(){return function(){if(a)return b(a);return!1}()},this.getTree=function(){var e=E(w,JSON.parse(JSON.stringify(f.tree)));if(e)return e},this.setData=function(e){e.hasOwnProperty("types")&&this.setTypes(e.types),e.hasOwnProperty("tree")&&this.setTree(e.tree)},this.setTypes=function(e){f.types=e},this.setTree=function(e){f.tree=e,f.tree.hasOwnProperty("state")||(f.tree.state="open"),P(),h()},this.newTree=function(){i=1,f.tree={_id_:i,type:"root",state:"open",label:f.root_label,element:null,items:[]},g()},this.filterTree=function(e){var s,a;s=e,a=[],function e(t,r,i,n){if(-1!==(r+t.label).indexOf(s)&&a.push(r+"/"+t.label),t.hasOwnProperty("items")&&t.items.length)for(var o=0;o<t.items.length;o++)e(t.items[o],r+"/"+t.label,t,o)}(f.tree,"")},this.destroy=function(){D(!1)},void 0!==OGX.Templater?(function(){for(var e in o)f.hasOwnProperty(e)||(f[e]=o[e]);void 0===window.ontouchstart||f.chromeos||(l="touchstart",u="touchmove",p="touchend"),n.el=_=$(f.container),_.addClass("ogx_tree"),_.attr("data-ogx-tree",s)}(),P(),D(!0),f.tree&&h()):console.log("%c CRITICAL ERROR - OGX.Templater not found! ","background:#222; color: #FF0000")},OGX.Tree.NAME="OgxTree",OGX.Tree.SELECT="TreeSelect",OGX.Tree.UNSELECT="TreeUnselect",OGX.Tree.OPEN="TreeOpen",OGX.Tree.CLOSE="TreeClose",OGX.Tree.DRAG="TreeDrag",OGX.Tree.DROP="TreeDrop";