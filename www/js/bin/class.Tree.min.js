OGX.Tree=function(e){"use strict";var _,d,c,p,t,r,s,n,o=this,m=e,i={show_root:!0,root_label:"root",editable:!1,reorder:!0,toggle:!0,drag_after:1e3,icon_path:"img/",scope:["public"],types:[{type:"root",mode:"folder",icons:{open:"folder_open.png",close:"folder_open.png"}},{type:"file",mode:"file",icon:"file.png"},{type:"folder",mode:"folder",icons:{open:"folder_open.png",close:"folder_open.png"}}],tree:{id:0,type:"root",label:m.root_label,state:"closed",items:[]},template:'<div class="ogx_tree_{{$type}} ogx_tree_item" data-type="{{$type}}" data-mode="{{$mode}}" data-id="{{$_id_}}" data-state="{{$state}}"><span class="ogx_tree_item_arrow {{$arrow_style}} {{$arrow_display}}"><span></span></span><img src="{{$icon}}" {{$css}} alt=""><div class="ogx_tree_item_label">{{$label}}</div><div class="ogx_tree_container {{$container_display}}"></div></div>'},a="mousedown",l="mouseup",f="mousemove";function u(){var e={icon:G("root","open"),mode:"folder",type:"root",_id_:m.tree._id_,label:m.root_label,state:"open",container_display:"",arrow_display:"",arrow_style:"ogx_tree_item_arrow_open"};_.html(OGX.Templater.templatize(e,m.template)),m.tree.element=_.children(".ogx_tree_root:first"),m.tree.label=m.root_label,g(m.tree,m.tree.element)}function g(e,t){if(e.hasOwnProperty("items")){var r,n;m.reorder?(i=e.items,a="label",s=1,i.sort((l=a,_=s,function(e,t){return e[l]<t[l]?-1*_:e[l]>t[l]?_:0})),r=i):r=e.items;for(var o=0;o<r.length;o++)n={icon:null,mode:X(e.items[o].type),type:e.items[o].type,_id_:e.items[o]._id_,label:e.items[o].label,state:0,container_display:"",arrow_display:"",arrow_style:""},e.items[o].hasOwnProperty("state")&&(n.state=e.items[o].state),"folder"!==n.mode?n.arrow_display="ogx_tree_item_arrow_hidden":(n.state||(n.state="open"),e.items[o].items.length||(n.arrow_style+=" ogx_tree_item_arrow_alpha")),"close"===n.state?n.container_display="ogx_tree_item_container_hidden":n.arrow_style+=" ogx_tree_item_arrow_open",n.icon=G(e.items[o].type,n.state),t.children(".ogx_tree_container:last").append(OGX.Templater.templatize(n,m.template)),e.items[o].element=t.children(".ogx_tree_container:last").children(".ogx_tree_item:last"),g(e.items[o],e.items[o].element)}var i,a,s,l,_}function h(e){var t=JSON.parse(JSON.stringify(e));return delete t._id_,delete t.element,t}function y(){if(s){var e=O(s);e&&(e.children("img:first").removeClass("ogx_tree_selected"),s=null)}}function v(o){return b(function(e,t,r,n){return e._id_===o&&(r.items.splice(n,1),!0)})}function x(t,r){return b(function(e){return e._id_===r&&(e.items.push(t),!0)})}function T(r){return b(function(e,t){return e._id_===r&&e})}function O(e){var t=T(e);return!!t&&t.element}function w(e){var r,t=(r=e,b(function(e,t){return r===t+"/"+e.label&&e}));return!!t&&t.element}function b(a,e){var s;if(void 0===e&&(e=m.tree),s=function e(t,r,n,o){if(s=a(t,r,n,o))return s;if(t.hasOwnProperty("items")&&t.items.length)for(var i=0;i<t.items.length;i++)if(s=e(t.items[i],r+"/"+t.label,t,i))return s;return!1}(e,""))return s}function C(e){for(var t=0;t<m.types.length;t++)if(m.types[t].type===e)return m.types[t];return!1}function G(e,t){void 0!==t&&t||(t="close");var r=C(e);return!!r&&(r.hasOwnProperty("icons")?m.icon_path+r.icons[t]:m.icon_path+r.icon)}function X(e){var t=C(e);return!!t&&t.mode}function E(e,t){var r=e.data("type");t?e.children("img").attr("src",G(r,"open")):e.children("img").attr("src",G(r,"close"))}function P(e){var t,r;r=h(T(t=e.data("id"))),m.toggle?e.children("img:first").hasClass("ogx_tree_selected")?(y(),_.trigger(OGX.Tree.UNSELECT,r)):(y(),e.children("img:first").addClass("ogx_tree_selected"),s=t,_.trigger(OGX.Tree.SELECT,r)):(y(),e.children("img:first").addClass("ogx_tree_selected"),_.trigger(OGX.Tree.SELECT,r))}function S(e){e?(m.editable?(_.on(a,".ogx_tree_item img",function(e){e.preventDefault(),P($(this).parent(0)),1!==$(this).parent(0).data("id")&&function(){t&&clearInterval(t);r=(new Date).getTime(),t=setInterval(D,50)}()}),$(document).on(l,function(){var e,t,r,n,o,i,a,s,l;N(),c&&(I(!1),r=c.offset().left,n=c.offset().top,i=r,a=n,!(o=b(function(e,t){return s=e.element.offset(),l=e.element.children("img:first"),i>=s.left&&i<=s.left+l.width()&&a>=s.top&&a<=s.top+l.height()&&e}))||o&&(o._id_===d._id_||"folder"!==X(o.type))?(p.css("opacity",1),c.remove(),d=c=null):(t=o,v((e=d)._id_),x(e,t._id_),t.element.children(".ogx_tree_item_arrow:first").removeClass("ogx_tree_item_arrow_alpha").removeClass("ogx_tree_item_arrow_close").addClass("ogx_tree_item_arrow_open"),1===e.element.parent(0).children().length&&e.element.parent(0).parent(0).children(".ogx_tree_item_arrow:first").addClass("ogx_tree_item_arrow_alpha").removeClass("ogx_tree_item_arrow_open").addClass("ogx_tree_item_arrow_close"),t.element.children(".ogx_tree_container:first").empty(),g(t,t.element),p.remove(),c.remove(),c=null,_.trigger(OGX.Tree.DROP,d),d=null))})):_.on("click",".ogx_tree_item img",function(e){e.preventDefault(),P($(this).parent(0))}),_.on(a,".ogx_tree_item_arrow",function(e){e.preventDefault(),N(),0<$(this).parent(0).children(".ogx_tree_container:first").children().length&&($(this).parent(0).children(".ogx_tree_container:first").toggle(),"none"===$(this).parent(0).children(".ogx_tree_container:first").css("display")?$(this).css("transform","rotate(0deg)"):$(this).css("transform","rotate(90deg)"),"folder"===$(this).parent(0).data("mode")&&("open"===$(this).parent(0).data("state")?(E($(this).parent(0),!1),$(this).parent(0).data("state","close"),$(m.container).trigger(OGX.Tree.CLOSE,T($(this).parent(0).data("data",n)))):(E($(this).parent(0),!0),$(this).parent(0).data("state","open"),$(m.container).trigger(OGX.Tree.OPEN,T($(this).parent(0).data("data",n))))))})):(m.editable?_.off(a,".ogx_tree_item img"):_.off("click",".ogx_tree_item img"),_.off(a,".ogx_tree_item_arrow"))}function D(){var e;(new Date).getTime()-r>=m.drag_after&&(s&&(d=T(s))&&(e=d.element,(c=(p=e).clone()).children(".ogx_tree_item_arrow:first").css("display","none"),e.css("opacity",.3),c.addClass("ogx_tree_item_drag"),c.css({top:e.offset().top,left:e.offset().left}),_.prepend(c),I(!0),_.trigger(OGX.Tree.DRAG,d)),N())}function I(e){e?$(document).on(f,function(e){e=function(e){if(e.hasOwnProperty("originalEvent")&&void 0!==e.originalEvent.changedTouches)return e.originalEvent.changedTouches[0];return e}(e),c.css({top:e.pageY+"px",left:e.pageX+"px"})}):$(document).off(f)}function N(){t&&(clearInterval(t),t=null)}this._NAME_=OGX.Tree.NAME,this.el=null,this.addItem=function(e){if(s){var t=T(s);return"folder"===X(t.type)&&(x(e,s),t.element.children(".ogx_tree_container:first").empty(),g(t,t.element)),!0}return!1},this.selectItemByPropVal=function(e,t){var r,n,o,i,a=(r=e,n=t,b(function(e,t){return!(!e.data.hasOwnProperty(r)||e.data[r]!==n)&&t+"/"+e.label}));return!!a&&(y(),o=a._id_,(i=O(o))&&(s=o,i.children("img:first").addClass("ogx_tree_selected")),!0)},this.selectItemByPath=function(e){var t=w(e);return!!t&&(y(),t.addClass("ogx_tree_selected"),s=t.data("id"),!0)},this.updateSelectedItemDataProperty=function(e,t){return!!s&&(T(s).data[e]=t,!0)},this.updateSelectedItemData=function(e){return!!s&&(T(s).data=e,!0)},this.updateSelectedItemLabel=function(e){if(s){var t=T(s);return t.label=e,O(t._id_).children(".ogx_tree_item_label:first").html(e),!0}return!1},this.deleteItemByPath=function(e){var t=w(e);return!!t&&v(t.data("id"))},this.deleteSelectedItem=function(){return function(){if(s)return b(function(e,t,r,n){if(e._id_===s)return e.element.remove(),r.splice(n,1),!0});return!1}()},this.getTree=function(){var e=b(h,JSON.parse(JSON.stringify(m.tree)));if(e)return e},this.setData=function(e){e.hasOwnProperty("types")&&this.setTypes(e.types),e.hasOwnProperty("tree")&&this.setTree(e.tree)},this.setTypes=function(e){m.types=e},this.setTree=function(e){m.tree=e,n=1,b(function(e){return e._id_=n++,!1}),u()},this.newTree=function(){!function(){n=1,m.tree={_id_:n,type:"root",mode:"folder",label:m.root_label,element:null,scopes:[],items:[]};var e={icon:G("root"),mode:"folder",type:"root",_id_:m.tree._id_,label:m.root_label,css:""};_.html(OGX.Templater.templatize(e,m.template)),m.tree.element=_.children(".ogx_tree_root:first")}()},this.destroy=function(){S(!1)},void 0!==OGX.Templater?(function(){for(var e in i)m.hasOwnProperty(e)||(m[e]=i[e]);void 0!==window.ontouchstart&&(a="touchstart",f="touchmove",l="touchend"),o.el=_=$(m.container)}(),S(!0),m.tree&&u()):console.log("%c CRITICAL ERROR - OGX.Templater not found! ","background:#222; color: #FF0000")},OGX.Tree.NAME="OgxTree",OGX.Tree.SELECT="TreeSelect",OGX.Tree.UNSELECT="TreeUnselect",OGX.Tree.OPEN="TreeOpen",OGX.Tree.CLOSE="TreeClose",OGX.Tree.DRAG="TreeDrag",OGX.Tree.DROP="TreeDrop";