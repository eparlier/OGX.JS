if("undefined"==typeof OGX)var OGX=function(){};OGX.prototype.ChatRoom=function(__config){"use strict";function render(){if(config.messages.length>0){for(var e=0;e<config.messages.length;e++)addMessage(config.messages[e]);scroller.update(),scroller.bottom()}}function addMessage(__msg){var u=config.users.find("_id",__msg.from),initals=u[0].first_name.substr(0,1).toUpperCase()+u[0].last_name.substr(0,1).toUpperCase();switch(config.display_mode){case OGX.ChatRoom.DISPLAY_INITIALS:__msg.letter=initals,__msg.bg="";break;case OGX.ChatRoom.DISPLAY_PICTURE:__msg.letter="";var e=eval("u[0]."+config.picture_key);"undefined"!==e?__msg.bg="background-image:url('"+e+"')":(__msg.letter=initals,__msg.bg="")}var html=OGX.Templater.templatize(__msg,getTemplate(__msg));inner.append(html);var msg=inner.children(".ogx_chatroom_message:last");setTimeout(function(){msg.addClass("ogx_chatroom_message_anim"),scroller.update(),scroller.bottom()},100)}function addTyping(e){typing[e]=!0;var o='<div class="ogx_chatroom_typing" data-user="'+e+'"><span class="ogx_chatroom_typing_body">.</div></div>';inner.append(o),animTyping(!0)}function removeTyping(e){typing[e]=!1,inner.find('.ogx_chatroom_typing[data-user="'+e+'"]').remove(),0===inner.find(".ogx_chatroom_typing").length&&animTyping(!1)}function animTyping(e){e?intv||(intv=setInterval(typeDot,config.dot_speed)):(clearInterval(intv),intv=null)}function typeDot(){type+=".",type.length>3?type=".":null,inner.find(".ogx_chatroom_typing_body").html(type)}function getTemplate(e){return e.user===config.user?config.template_right:config.template_left}function sendMessage(){var e=composer.find("textarea:first").val();new Date;if(e.length>0){e=e.replace(/[\r\n]/g,"<br>");var o={from:config.user,body:e,date:moment().format(config.date_format)};addMessage(o),composer.find("textarea:first").val(""),that.el.trigger(OGX.ChatRoom.SEND_MSG,o)}}function handleShowKeyb(e){oldh=container.height(),container.height(container.height()-e.keyboardHeight),updateScroller()}function handleHideKeyb(){container.height(oldh),updateScroller()}function updateScroller(){setTimeout(function(){scroller.update(),scroller.bottom()},config.on_keyb_update_delay)}function listenKeyb(e){e?(window.addEventListener("native.keyboardshow",handleShowKeyb),window.addEventListener("native.keyboardhide",handleHideKeyb)):(window.removeEventListener("native.keyboardshow",handleShowKeyb),window.removeEventListener("native.keyboardhide",handleHideKeyb))}function listenArea(e){e?composer.on("keyup","textarea",function(e){13===e.which&&(sendMessage(),config.hide_keyboard_on_send&&handleHideKeyb())}):composer.off("keyup","textarea")}function listenComposer(e){e?composer.on("click",".ogx_chatroom_composer_send",function(){sendMessage(),config.hide_keyboard_on_send&&handleHideKeyb()}):composer.off("click",".ogx_chatroom_composer_send")}function initScroller(){scroller=new OGX.Scroller({container:that.el.find(".ogx_chatroom_messages:first")[0],initDelay:100,autoScroll:!0,naturalScroll:config.natural_scroll}),that.el.on(OGX.Scroller.READY,function(){that.el.off(OGX.Scroller.READY),inner=scroller.getInner(),inner=$(inner),inner.addClass("ogx_chatroom_messages_inner"),scroller.update(),render()})}function initMarkup(){var e='<div class="ogx_chatroom_messages"></div><div class="ogx_chatroom_composer">';e+='<span class="ogx_chatroom_composer_input"><textarea placeholder="'+config.placeholder+'">',e+='</textarea></span><span class="ogx_chatroom_composer_send"></span></div>',container.append(e),composer=container.find(".ogx_chatroom_composer:first")}function initUsers(){for(var e in config.users)typing[e]=!1}function initDefaults(){for(var e in config_default)config.hasOwnProperty(e)||(config[e]=config_default[e]);config.users.hasOwnProperty("find")||(config.users=new OGX.List(config.users)),that.el=container=$(config.container),container.addClass("ogx_chatroom")}function init(){return"undefined"==typeof OGX.Scroller?void console.log("%c CRITICAL ERROR - OGX.Scroller not found! ","background:#222; color: #FF0000"):"undefined"==typeof OGX.Templater?void console.log("%c CRITICAL ERROR - OGX.Templater not found! ","background:#222; color: #FF0000"):"undefined"==typeof moment?void console.log("%c CRITICAL ERROR - moment.js not found! ","background:#222; color: #FF0000"):config.restrict&&"undefined"==typeof OGX.FormTools?void console.log("%c CRITICAL ERROR - OGX.FormTools not found! ","background:#222; color: #FF0000"):(initDefaults(),initMarkup(),initUsers(),initScroller(),config.handle_keyboard&&listenKeyb(!0),listenComposer(!0),config.restrict&&OGX.FormTools.restrictField(that.el.find(".ogx_chatroom_composer:first .ogx_chatroom_composer_input:first textarea")[0],config.restrict),listenArea(!0),void(winh=$(window).height()))}var that=this,config=__config,config_default={placeholder:"Type a message",dot_speed:600,on_keyb_update_delay:200,messages:[],natural_scroll:!0,handle_keyboard:!0,hide_keyboard_on_send:!1,mode:OGX.ChatRoom.MODE_DESKTOP,template_left:'<div class="ogx_chatroom_message ogx_chatroom_message_left" data-user="{{$user}}"><span class="ogx_chatroom_message_icon" style="{{$bg}}"><span>{{$letter}}</span></span><span class="ogx_chatroom_message_container"><span class="ogx_chatroom_message_body">{{$body}}</span><span class="ogx_chatroom_message_date">{{$date}}</span><span style="clear:both"></span></span></div>',template_right:'<div class="ogx_chatroom_message ogx_chatroom_message_right" data-user="$user"><span class="ogx_chatroom_message_container"><span class="ogx_chatroom_message_body">{{$body}}</span><span class="ogx_chatroom_message_date">{{$date}} {{$time}}</span><span style="clear:both"></span></span></div>',key:"_id",users:[],user:!1,display_mode:OGX.ChatRoom.DISPLAY_INITIALS,picture_key:"",restrict:!1,date_format:"YYYY-MM-DD h:mm:ss A"},container,inner,scroller,composer,intv,oldh,winh,typing={},type=".";this.el=null,this.setUsers=function(e){config.users=e},this.setUser=function(e){config.user=e},this.addMessage=function(e){addMessage(e)},this.setMessages=function(e){config.messages=e,render()},this.userTyping=function(e,o){e&&!typing[o]?addTyping(o):!e&&typing[o]&&removeTyping(o)},this.setCompose=function(e){composer.find("textarea:first").val(e)},this.clear=function(){inner.empty()},this.destroy=function(){config.restrict&&OGX.FormTools.unrestrictField(that.el.find(".ogx_chatroom_composer:first .ogx_chatroom_composer_input:first textarea")[0]),listenKeyb(!1),listenArea(!1),listenComposer(!1)},init()},OGX.ChatRoom=function(e){"use strict";return new OGX.prototype.ChatRoom(e)},OGX.ChatRoom.MODE_DESKTOP="desktop",OGX.ChatRoom.MODE_MOBILE="mobile",OGX.ChatRoom.SEND_MSG="ChatRoomSend",OGX.ChatRoom.DISPLAY_INITIALS="ChatRoomDisplayInitials",OGX.ChatRoom.DISPLAY_PICTURE="ChatRoomDisplayPicture";