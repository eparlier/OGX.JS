if(void 0===OGX)var OGX=function(){};OGX.ChatRoom=function(__config){"use strict";var that=this,config=__config,config_default={placeholder:"Type a message",dot_speed:600,on_keyb_update_delay:300,messages:[],handle_keyboard:!0,hide_keyboard_on_send:!1,template_left:'<div class="ogx_chatroom_message ogx_chatroom_message_left" style="{{$opacity}} data-id="$uid"><span class="ogx_chatroom_message_icon" style="{{$bg}}"><span>{{$letter}}</span></span><span class="ogx_chatroom_message_container"><span class="ogx_chatroom_message_body">{{$body}}</span><span class="ogx_chatroom_message_date">{{$date}}</span><span style="clear:both"></span></span></div>',template_right:'<div class="ogx_chatroom_message ogx_chatroom_message_right" style="{{$opacity}}" data-id="{{$uid}}"><span class="ogx_chatroom_message_container"><span class="ogx_chatroom_message_body">{{$body}}</span><span class="ogx_chatroom_message_date">{{$date}} {{$time}}</span><span style="clear:both"></span></span></div>',key:"_id",users:[],user:!1,display_mode:OGX.ChatRoom.DISPLAY_INITIALS,picture_key:"",restrict:{multiline:!1,length:500},date_format:"YYYY-MM-DD h:mm:ss A"},container,inner,scroller,composer,intv,winh,oldh=!1,typing={},type=".";function render(){if(0<config.messages.length){for(var e=0;e<config.messages.length;e++)addMessage(config.messages[e]);scroller.update(),scroller.bottom()}}function addMessage(__msg,__prepend){void 0===__prepend&&(__prepend=!1);var u=config.users.find("_id",__msg.from),initals=u[0].first_name.substr(0,1).toUpperCase()+u[0].last_name.substr(0,1).toUpperCase();switch(config.display_mode){case OGX.ChatRoom.DISPLAY_INITIALS:__msg.letter=initals,__msg.bg="";break;case OGX.ChatRoom.DISPLAY_PICTURE:__msg.letter="";var e=eval("u[0]."+config.picture_key);"undefined"!==e?__msg.bg="background-image:url('"+e+"')":(__msg.letter=initals,__msg.bg="")}__msg.uid=__msg.from,__msg.opacity=__prepend?"opacity:1;":"";var html=OGX.Templater.templatize(__msg,getTemplate(__msg));__prepend?inner.prepend(html):inner.append(html);var msg=inner.children(".ogx_chatroom_message:last");setTimeout(function(){msg.addClass("ogx_chatroom_message_anim"),scroller.update(),__prepend||scroller.bottom()},100)}function addTyping(e){typing[e]=!0;var o='<div class="ogx_chatroom_typing" data-user="'+e+'"><span class="ogx_chatroom_typing_body">.</div></div>';inner.append(o),animTyping(!0)}function removeTyping(e){typing[e]=!1,inner.find('.ogx_chatroom_typing[data-user="'+e+'"]').remove(),0===inner.find(".ogx_chatroom_typing").length&&animTyping(!1)}function animTyping(e){e?intv||(intv=setInterval(typeDot,config.dot_speed)):(clearInterval(intv),intv=null)}function typeDot(){3<(type+=".").length&&(type="."),inner.find(".ogx_chatroom_typing_body").html(type)}function getTemplate(e){return e.from===config.user?config.template_right:config.template_left}function sendMessage(){var e=composer.find("textarea:first").val();if(e.length&&(e=(e=(e=e.replace(/^[\r|\n\r]+/,"")).replace(/<>\*/,"")).replace(/â€™/,"'")).length){e=e.replace(/[\r\n]/g,"<br>");var o={from:config.user,body:e,date:moment().format(config.date_format)};addMessage(o);var t=JSON.parse(JSON.stringify(o));delete t.bg,delete t.letter,composer.find("textarea:first").val(""),that.el.trigger(OGX.ChatRoom.SEND_MESSAGE,t)}}function handleShowKeyb(e){oldh||(oldh=container.height()),container.height(oldh-e.keyboardHeight),updateScroller()}function handleHideKeyb(){container.height(oldh),updateScroller()}function updateScroller(){setTimeout(function(){scroller.update(),scroller.bottom()},config.on_keyb_update_delay)}function listenKeyb(e){e?(window.addEventListener("native.keyboardshow",handleShowKeyb),window.addEventListener("native.keyboardhide",handleHideKeyb)):(window.removeEventListener("native.keyboardshow",handleShowKeyb),window.removeEventListener("native.keyboardhide",handleHideKeyb))}function listenArea(e){e?composer.on("keyup","textarea",function(e){13===e.which&&(sendMessage(),config.hide_keyboard_on_send&&handleHideKeyb())}):composer.off("keyup","textarea")}function listenComposer(e){e?composer.on("click",".ogx_chatroom_composer_send",function(){sendMessage(),config.hide_keyboard_on_send&&handleHideKeyb()}):composer.off("click",".ogx_chatroom_composer_send")}function initScroller(){scroller=new OGX.Scroller({container:that.el.find(".ogx_chatroom_messages:first")[0],initDelay:100,autoScroll:!0}),that.el.on(OGX.Scroller.READY,function(){that.el.off(OGX.Scroller.READY),inner=scroller.getInner(),(inner=$(inner)).addClass("ogx_chatroom_messages_inner"),scroller.update(),render()})}function initMarkup(){var e='<div class="ogx_chatroom_messages"></div><div class="ogx_chatroom_composer">';e+='<span class="ogx_chatroom_composer_input"><textarea placeholder="'+config.placeholder+'">',e+='</textarea></span><span class="ogx_chatroom_composer_send"></span></div>',container.append(e),composer=container.find(".ogx_chatroom_composer:first")}function initUsers(){for(var e in config.users)typing[e]=!1}function initDefaults(){for(var e in config_default)config.hasOwnProperty(e)||(config[e]=config_default[e]);config.users.hasOwnProperty("find")||(config.users=new OGX.List(config.users)),that.el=container=$(config.container),container.addClass("ogx_chatroom")}function init(){if(void 0!==OGX.Scroller)if(void 0!==OGX.Templater)if("undefined"!=typeof moment)if(config.restrict&&void 0===OGX.FormTools)console.log("%c CRITICAL ERROR - OGX.FormTools not found! ","background:#222; color: #FF0000");else{if(initDefaults(),initMarkup(),initUsers(),initScroller(),config.handle_keyboard&&listenKeyb(!0),listenComposer(!0),config.restrict){var e=JSON.parse(JSON.stringify(config.restrict));e.container=that.el.find(".ogx_chatroom_composer:first .ogx_chatroom_composer_input:first textarea")[0],OGX.FormTools.restrictField(e)}listenArea(!0),winh=$(window).height()}else console.log("%c CRITICAL ERROR - moment.js not found! ","background:#222; color: #FF0000");else console.log("%c CRITICAL ERROR - OGX.Templater not found! ","background:#222; color: #FF0000");else console.log("%c CRITICAL ERROR - OGX.Scroller not found! ","background:#222; color: #FF0000")}this._NAME_=OGX.ChatRoom.NAME,this.el=null,this.setUsers=function(e){e.hasOwnProperty("find")||(e=new OGX.List(e)),config.users=e},this.setUser=function(e){config.user=e},this.addMessage=function(e){addMessage(e)},this.setMessages=function(e){config.messages=e,render()},this.prependMessages=function(e){for(var o=0;o<e.length;o++)addMessage(e[o],!0);config.messages=e.concat(config.messages)},this.userTyping=function(e,o){e&&!typing[o]?addTyping(o):!e&&typing[o]&&removeTyping(o)},this.setCompose=function(e){composer.find("textarea:first").val(e)},this.clear=function(){inner.empty()},this.getScroller=function(){return scroller},this.destroy=function(){config.restrict&&OGX.FormTools.unrestrictField(that.el.find(".ogx_chatroom_composer:first .ogx_chatroom_composer_input:first textarea")[0]),listenKeyb(!1),listenArea(!1),listenComposer(!1)},init()},OGX.ChatRoom.NAME="OgxChatRoom",OGX.ChatRoom.SEND_MESSAGE="ChatRoomSend",OGX.ChatRoom.DISPLAY_INITIALS="ChatRoomDisplayInitials",OGX.ChatRoom.DISPLAY_PICTURE="ChatRoomDisplayPicture";